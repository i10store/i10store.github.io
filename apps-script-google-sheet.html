/**
 * ===========================
 *   I10 PRODUCT DRIVE EXPORT
 * ===========================
 * T·ª± ƒë·ªông t·∫°o, ƒë·ªìng b·ªô, d·ªçn d·∫πp v√† xu·∫•t JSON s·∫£n ph·∫©m + banner.
 */

const SHEET_NAME = "Web";
const CACHE_KEY_PRODUCTS = "i10_cached_products";
const DRIVE_ROOT_ID = "1ZO7AcpmyShKm2j0EVNorme7mYKRN2VcQ"; // th∆∞ m·ª•c Drive g·ªëc
const FOLDER_ID_BANNER = "1h1qRJQVMTtzTfXxyPPUgrIilyARr37o7"; // th∆∞ m·ª•c banner


/** ==================== MENU ==================== */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("üß∞ I10 Tools")
    .addItem("üìÅ T·∫°o / ƒê·ªìng b·ªô Folder Drive", "createProductFolders")
    .addItem("üßπ D·ªçn d·∫πp Folder d∆∞", "checkAndCleanExtraFolders")
    .addItem("üîç Ki·ªÉm tra link Folder Drive", "checkDriveLinkMatch")
    .addItem("üñº Ki·ªÉm tra Folder r·ªóng (kh√¥ng c√≥ ·∫£nh)", "checkEmptyImageFolders")
    .addSeparator()
    .addItem("‚ôªÔ∏è C·∫≠p nh·∫≠t JSON th·ªß c√¥ng", "updateCachedJson")
    .addItem("üö´ X√≥a Cache JSON", "clearCachedJson")
    .addSeparator()
    .addItem("üåê M·ªü WebApp", "openWebAppLink")
    .addToUi();
}

/** ==================== M·ªû WEBAPP ==================== */
function openWebAppLink() {
  const url = ScriptApp.getService().getUrl();
  if (url) {
    SpreadsheetApp.getUi().alert("üåê WebApp URL:\n" + url);
  } else {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è Ch∆∞a tri·ªÉn khai WebApp.\nV√†o menu: Deploy ‚Üí New Deployment ‚Üí Web app");
  }
}

/** ==================== L·∫§Y ID FOLDER ==================== */
function extractFolderId(url) {
  if (!url) return "";
  const patterns = [/\/folders\/([-\w]{20,})/, /id=([-\w]{20,})/, /[-\w]{25,}/];
  for (const re of patterns) {
    const match = url.match(re);
    if (match) return match[1];
  }
  return "";
}

/** =======================================================
 * 1Ô∏è‚É£ T·∫†O / ƒê·ªíNG B·ªò FOLDER THEO C·ªòT Name + L∆∞u ID C·ªê ƒê·ªäNH
 * ======================================================= */
function createProductFolders() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  const nameCol = headers.indexOf("Name");
  const driveCol = headers.indexOf("Folder Album Image Google Drive");
  const idCol = headers.indexOf("Folder ID");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i t·∫°o folder");

  if (idCol === -1) {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è Vui l√≤ng th√™m c·ªôt 'Folder ID' ƒë·ªÉ l∆∞u ID c·ªë ƒë·ªãnh.");
    return;
  }

  const root = DriveApp.getFolderById(DRIVE_ROOT_ID);
  const folders = {};
  const iter = root.getFolders();
  while (iter.hasNext()) {
    const f = iter.next();
    folders[f.getId()] = f.getName();
  }

  let created = 0, updated = 0;

  data.forEach((row, i) => {
    const name = (row[nameCol] || "").toString().trim();
    if (!name) return;

    const folderId = (row[idCol] || "").toString().trim();
    const link = (row[driveCol] || "").toString().trim();

    try {
      let folder = null;
      if (folderId && folders[folderId]) folder = DriveApp.getFolderById(folderId);
      else {
        const found = root.getFoldersByName(name);
        if (found.hasNext()) folder = found.next();
      }

      if (!folder) {
        folder = root.createFolder(name);
        created++;
      } else {
        updated++;
      }

      const newLink = `https://drive.google.com/drive/folders/${folder.getId()}`;
      if (link !== newLink) sheet.getRange(i + 2, driveCol + 1).setValue(newLink);
      if (folderId !== folder.getId()) sheet.getRange(i + 2, idCol + 1).setValue(folder.getId());
      sheet.getRange(i + 2, statusCol + 1).setValue("‚úÖ OK");
    } catch (err) {
      sheet.getRange(i + 2, statusCol + 1).setValue("‚ùå " + err.message);
    }
  });

  sheet.getRange("AA1").setValue(`L·∫ßn t·∫°o/ƒë·ªìng b·ªô g·∫ßn nh·∫•t: ${new Date().toLocaleString("vi-VN")}`);
  SpreadsheetApp.getActive().toast(`‚úÖ T·∫°o ${created}, ƒë·ªìng b·ªô ${updated} folder.`);
}

/** =======================================================
 * 2Ô∏è‚É£ D·ªåN D·∫∏P FOLDER D∆Ø
 * ======================================================= */
function checkAndCleanExtraFolders() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const nameCol = headers.indexOf("Name");
  const validNames = new Set(data.map(r => (r[nameCol] || "").toString().trim()).filter(Boolean));

  const root = DriveApp.getFolderById(DRIVE_ROOT_ID);
  const recycle = root.getFoldersByName("_Recycle").hasNext() ? root.getFoldersByName("_Recycle").next() : root.createFolder("_Recycle");

  const extras = [];
  const folders = root.getFolders();
  while (folders.hasNext()) {
    const f = folders.next();
    if (f.getName() === "_Recycle") continue;
    if (!validNames.has(f.getName().trim())) extras.push(f);
  }

  if (!extras.length) {
    SpreadsheetApp.getUi().alert("‚úÖ Kh√¥ng c√≥ folder d∆∞!");
    return;
  }

  extras.forEach(f => {
    try { f.moveTo(recycle); } catch (err) { Logger.log("Kh√¥ng di chuy·ªÉn ƒë∆∞·ª£c: " + f.getName()); }
  });

  sheet.getRange("AB1").setValue(`L·∫ßn d·ªçn g·∫ßn nh·∫•t: ${new Date().toLocaleString("vi-VN")}`);
  SpreadsheetApp.getActive().toast(`üßπ ƒê√£ chuy·ªÉn ${extras.length} folder d∆∞ v√†o _Recycle.`);
}

/** =======================================================
 * 3Ô∏è‚É£ XU·∫§T JSON S·∫¢N PH·∫®M + CACHE
 * ======================================================= */
function getImagesFromFolder(folderId) {
  try {
    const q = `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`;
    const res = Drive.Files.list({ q, fields: "files(id, name, mimeType)" });
    return (res.files || []).map(f => ({
      id: f.id,
      name: f.name,
      url: `https://drive.google.com/uc?export=view&id=${f.id}`,
      thumb: `https://lh3.googleusercontent.com/d/${f.id}=s1000`
    }));
  } catch (err) {
    Logger.log("Drive error: " + err.message);
    return [];
  }
}

function sheetToObjects(sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const values = sheet.getDataRange().getValues();
  const headers = values.shift();
  return values.map(row => Object.fromEntries(headers.map((h, i) => [h, row[i]])));
}

/** ‚ö° C·∫≠p nh·∫≠t cache JSON s·∫£n ph·∫©m */
function updateCachedJson() {
  const data = sheetToObjects(SHEET_NAME)
    .filter(p => p["Brand"])
    .map(p => {
      const folderId = extractFolderId(p["Folder Album Image Google Drive"]);
      const images = folderId ? getImagesFromFolder(folderId) : [];
      return { ...p, images };
    });

  const cache = CacheService.getScriptCache();
  cache.put(CACHE_KEY_PRODUCTS, JSON.stringify(data), 21600); // 6h
  SpreadsheetApp.getActive().toast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t cache JSON s·∫£n ph·∫©m.");
}

/** üßπ X√≥a cache JSON s·∫£n ph·∫©m */
function clearCachedJson() {
  const cache = CacheService.getScriptCache();
  cache.remove(CACHE_KEY_PRODUCTS);
  SpreadsheetApp.getActive().toast("üö´ ƒê√£ x√≥a cache JSON s·∫£n ph·∫©m.");
}

/** doGet ‚Äî ph·ª•c v·ª• web */
function doGet(e) {
  const mode = e?.parameter?.mode;
  const cache = CacheService.getScriptCache();

  if (mode === "banner") {
    const banners = getImagesFromFolder(FOLDER_ID_BANNER);
    return ContentService.createTextOutput(JSON.stringify(banners)).setMimeType(ContentService.MimeType.JSON);
  }

  const cached = cache.get(CACHE_KEY_PRODUCTS);
  if (cached) {
    return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);
  }

  const data = sheetToObjects(SHEET_NAME)
    .filter(p => p["Brand"])
    .map(p => {
      const folderId = extractFolderId(p["Folder Album Image Google Drive"]);
      const images = folderId ? getImagesFromFolder(folderId) : [];
      return { ...p, images };
    });

  cache.put(CACHE_KEY_PRODUCTS, JSON.stringify(data), 21600);
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

/** =======================================================
 * 4Ô∏è‚É£ NH·∫¨N ƒê∆†N H√ÄNG
 * ======================================================= */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Order") || ss.insertSheet("Order");
    if (sheet.getLastRow() === 0)
      sheet.appendRow(["Th·ªùi gian", "T√™n", "ƒêi·ªán tho·∫°i", "S·∫£n ph·∫©m", "Ghi ch√∫"]);

    sheet.appendRow([new Date(), data.name, data.phone, data.product, data.note]);
    return ContentService.createTextOutput(JSON.stringify({ status: "ok" })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * =======================================================
 * üîç KI·ªÇM TRA C√ÅC FOLDER DRIVE R·ªñNG (KH√îNG C√ì ·∫¢NH)
 *  - ƒê√°nh d·∫•u tr·ª±c ti·∫øp tr√™n sheet
 *  - Hi·ªÉn th·ªã danh s√°ch chi ti·∫øt
 * =======================================================
 */
function checkEmptyImageFolders() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  const nameCol = headers.indexOf("Name");
  const driveCol = headers.indexOf("Folder Album Image Google Drive");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i t·∫°o folder") > -1 ? headers.indexOf("Tr·∫°ng th√°i t·∫°o folder") : headers.length;

  if (nameCol === -1 || driveCol === -1) {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è Thi·∫øu c·ªôt Name ho·∫∑c Folder Album Image Google Drive.");
    return;
  }

  const emptyFolders = [];
  let checked = 0;

  // Reset m√†u n·ªÅn c≈© (n·∫øu c√≥)
  const rangeToClear = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
  rangeToClear.setBackground(null);

  data.forEach((row, i) => {
    const name = (row[nameCol] || "").toString().trim();
    const driveLink = (row[driveCol] || "").toString().trim();
    if (!driveLink) return;

    const folderId = extractFolderId(driveLink);
    if (!folderId) return;

    try {
      const query = `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`;
      const files = Drive.Files.list({ q: query, fields: "files(id)" }).files || [];
      checked++;
      if (files.length === 0) {
        const rowIndex = i + 2;
        emptyFolders.push({ row: rowIndex, name, link: driveLink });
        // üé® T√¥ m√†u v√†ng c·∫£nh b√°o
        sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).setBackground("#fff8b3");
        sheet.getRange(rowIndex, statusCol + 1).setValue("‚ö†Ô∏è Folder r·ªóng (kh√¥ng c√≥ ·∫£nh)");
      }
    } catch (err) {
      const rowIndex = i + 2;
      emptyFolders.push({ row: rowIndex, name, link: driveLink, error: err.message });
      sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).setBackground("#ffcccc");
      sheet.getRange(rowIndex, statusCol + 1).setValue("‚ùå L·ªói ƒë·ªçc folder");
    }
  });

  // Hi·ªÉn th·ªã k·∫øt qu·∫£
  if (emptyFolders.length === 0) {
    SpreadsheetApp.getUi().alert(`‚úÖ ƒê√£ ki·ªÉm tra ${checked} folder. T·∫•t c·∫£ ƒë·ªÅu c√≥ ·∫£nh!`);
    return;
  }

  // T·∫°o b·∫£ng HTML hi·ªÉn th·ªã danh s√°ch r·ªóng
  let html = `
  <html><head>
  <style>
    body{font-family:sans-serif;padding:10px;font-size:13px;}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #ccc;padding:5px;}
    th{background:#f3f3f3;}
  </style></head><body>
  <h3>‚ö†Ô∏è Ph√°t hi·ªán ${emptyFolders.length} folder kh√¥ng ch·ª©a ·∫£nh</h3>
  <table>
    <tr><th>H√†ng</th><th>T√™n s·∫£n ph·∫©m</th><th>Link folder</th><th>L·ªói</th></tr>
    ${emptyFolders
      .map(
        (f) => `
      <tr>
        <td>${f.row}</td>
        <td>${f.name}</td>
        <td><a href="${f.link}" target="_blank">üîó M·ªü Folder</a></td>
        <td>${f.error || "Kh√¥ng c√≥ ·∫£nh"}</td>
      </tr>`
      )
      .join("")}
  </table>
  <p><i>‚Üí C√°c d√≤ng r·ªóng ƒë√£ ƒë∆∞·ª£c t√¥ <b style="color:#b36b00;">v√†ng c·∫£nh b√°o</b> ho·∫∑c <b style="color:red;">ƒë·ªè l·ªói</b> tr√™n sheet Web.</i></p>
  </body></html>`;

  SpreadsheetApp.getUi().showSidebar(HtmlService.createHtmlOutput(html).setTitle("üñº Folder r·ªóng"));
}

