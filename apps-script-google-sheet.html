/**
 * ===========================
 * I10 PRODUCT DRIVE EXPORT (N√¢ng c·∫•p v3 - S·ª≠a l·ªói Model tr·ªëng)
 * ===========================
 * T·ª± ƒë·ªông t·∫°o, ƒë·ªìng b·ªô, d·ªçn d·∫πp v√† xu·∫•t JSON s·∫£n ph·∫©m + banner.
 */

const SHEET_NAME = "Web";
const CACHE_KEY_PRODUCTS = "i10_cached_products";
const CACHE_KEY_BANNER = "i10_cached_banner";
const DRIVE_ROOT_ID = "1ZO7AcpmyShKm2j0EVNorme7mYKRN2VcQ"; // th∆∞ m·ª•c Drive g·ªëc
const FOLDER_ID_BANNER = "1h1qRJQVMTtzTfXxyPPUgrIilyARr37o7"; // th∆∞ m·ª•c banner


/** ==================== MENU ==================== */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("üß∞ I10 Tools")
    .addItem("üìÅ T·∫°o / ƒê·ªìng b·ªô Folder Drive", "createProductFolders")
    .addItem("‚úçÔ∏è C·∫≠p nh·∫≠t/T·∫°o Link Web (N√¢ng cao)", "generateAndWriteWebLinks") // <-- N√¢ng c·∫•p
    .addItem("üßπ D·ªçn d·∫πp Folder d∆∞", "checkAndCleanExtraFolders")
    .addItem("üîç Ki·ªÉm tra link Folder Drive", "checkDriveLinkMatch")
    .addItem("üñº Ki·ªÉm tra Folder r·ªóng (kh√¥ng c√≥ ·∫£nh)", "checkEmptyImageFolders")
    .addSeparator()
    .addItem("‚ôªÔ∏è C·∫≠p nh·∫≠t JSON th·ªß c√¥ng", "updateCachedJson")
    .addItem("üö´ X√≥a Cache JSON", "clearCachedJson")
    .addSeparator()
    .addItem("üåê M·ªü WebApp", "openWebAppLink")
    .addToUi();
}

/** ==================== M·ªû WEBAPP ==================== */
function openWebAppLink() {
  const url = ScriptApp.getService().getUrl();
  if (url) {
    SpreadsheetApp.getUi().alert("üåê WebApp URL:\n" + url);
  } else {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è Ch∆∞a tri·ªÉn khai WebApp.\nV√†o menu: Deploy ‚Üí New Deployment ‚Üí Web app");
  }
}

/** ==================== HELPERS (Slug & ID) ==================== */
function extractFolderId(url) {
  if (!url) return "";
  const patterns = [/\/folders\/([-\w]{20,})/, /id=([-\w]{20,})/, /[-\w]{25,}/];
  for (const re of patterns) {
    const match = url.match(re);
    if (match) return match[1];
  }
  return "";
}

// (*** M·ªöI - V·∫•n ƒë·ªÅ 2 ***) H√†m t·∫°o slug (link)
function createSlug(text) {
    if (!text) return "";
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Thay th·∫ø kho·∫£ng tr·∫Øng b·∫±ng -
        .replace(/\//g, '-')            // Thay th·∫ø / b·∫±ng -
        .replace(/@/g, 'at')            // Thay th·∫ø @
        .replace(/[^\w\-]+/g, '')       // X√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát
        .replace(/\-\-+/g, '-')         // Thay th·∫ø nhi·ªÅu - b·∫±ng 1 -
        .replace(/^-+/, '')             // X√≥a - ·ªü ƒë·∫ßu
        .replace(/-+$/, '');            // X√≥a - ·ªü cu·ªëi
}


/** =======================================================
 * 1Ô∏è‚É£ T·∫†O / ƒê·ªíNG B·ªò FOLDER (Gi·ªØ nguy√™n)
 * ======================================================= */
function createProductFolders() {
  // (Gi·ªØ nguy√™n code)
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const nameCol = headers.indexOf("Name");
  const driveCol = headers.indexOf("Folder Album Image Google Drive");
  const idCol = headers.indexOf("Folder ID");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i t·∫°o folder");
  if (idCol === -1) { SpreadsheetApp.getUi().alert("‚ö†Ô∏è Vui l√≤ng th√™m c·ªôt 'Folder ID'."); return; }
  const root = DriveApp.getFolderById(DRIVE_ROOT_ID);
  const folders = {};
  const iter = root.getFolders();
  while (iter.hasNext()) { const f = iter.next(); folders[f.getId()] = f.getName(); }
  let created = 0, updated = 0;
  data.forEach((row, i) => {
    const name = (row[nameCol] || "").toString().trim();
    if (!name) return;
    const folderId = (row[idCol] || "").toString().trim();
    const link = (row[driveCol] || "").toString().trim();
    try {
      let folder = null;
      if (folderId && folders[folderId]) folder = DriveApp.getFolderById(folderId);
      else { const found = root.getFoldersByName(name); if (found.hasNext()) folder = found.next(); }
      if (!folder) { folder = root.createFolder(name); created++; } else { updated++; }
      const newLink = `https://drive.google.com/drive/folders/${folder.getId()}`;
      if (link !== newLink) sheet.getRange(i + 2, driveCol + 1).setValue(newLink);
      if (folderId !== folder.getId()) sheet.getRange(i + 2, idCol + 1).setValue(folder.getId());
      sheet.getRange(i + 2, statusCol + 1).setValue("‚úÖ OK");
    } catch (err) { sheet.getRange(i + 2, statusCol + 1).setValue("‚ùå " + err.message); }
  });
  sheet.getRange("AA1").setValue(`L·∫ßn t·∫°o/ƒë·ªìng b·ªô g·∫ßn nh·∫•t: ${new Date().toLocaleString("vi-VN")}`);
  SpreadsheetApp.getActive().toast(`‚úÖ T·∫°o ${created}, ƒë·ªìng b·ªô ${updated} folder.`);
}

/** =======================================================
 * (*** S·ª¨A L·ªñI - V·∫•n ƒë·ªÅ 2 ***) 2Ô∏è‚É£ T·∫†O V√Ä GHI LINK WEB
 * ======================================================= */
function generateAndWriteWebLinks() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  // ƒê·ªçc c√°c c·ªôt c·∫ßn thi·∫øt
  const modelCol = headers.indexOf("Model");
  const nameCol = headers.indexOf("Name");
  const cpuCol = headers.indexOf("CPU");
  const ramCol = headers.indexOf("RAM");
  const resCol = headers.indexOf("RESOLUTION");
  const gpuCol = headers.indexOf("GPU - CARD");
  const webLinkCol = headers.indexOf("Web Link"); // ƒê·ªçc c·ªôt m·ªõi

  if (webLinkCol === -1) {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·ªôt 'Web Link'.\nVui l√≤ng th√™m c·ªôt n√†y (t√™n ch√≠nh x√°c) v√† th·ª≠ l·∫°i.");
    return;
  }
  
  if (modelCol === -1) {
    SpreadsheetApp.getUi().alert("‚ö†Ô∏è C·∫ßn c·ªôt 'Model' ƒë·ªÉ t·∫°o link.");
    return;
  }


  let updated = 0;
  const links = new Set(); // D√πng ƒë·ªÉ ki·ªÉm tra link tr√πng

  data.forEach((row, i) => {
    
    // (*** S·ª¨A L·ªñI V·∫•n ƒë·ªÅ 2 ***)
    // N·∫øu Model tr·ªëng th√¨ b·ªè qua
    const model = (row[modelCol] || "").toString().trim();
    if (!model) {
        // (T√πy ch·ªçn: X√≥a link c≈© n·∫øu model b·ªã x√≥a)
        // if (row[webLinkCol] !== "") {
        //     sheet.getRange(i + 2, webLinkCol + 1).setValue("");
        // }
        return; 
    }

    // T·∫°o chu·ªói text t·ª´ c√°c th√¥ng s·ªë
    const textToSlug = [
        model, // Ch·ªâ d√πng model (ƒë√£ ki·ªÉm tra kh√¥ng r·ªóng)
        row[cpuCol],
        row[ramCol],
        row[resCol],
        row[gpuCol]
    ].filter(Boolean).join(' '); // N·ªëi c√°c th√¥ng s·ªë
    
    let slug = createSlug(textToSlug || `san-pham-${i+2}`);
    
    // X·ª≠ l√Ω slug tr√πng
    let originalSlug = slug;
    let count = 2;
    while (links.has(slug)) {
      slug = `${originalSlug}-${count++}`;
    }
    links.add(slug);

    const webLink = `#${slug}`; // D·∫°ng link hash
    
    if (row[webLinkCol] !== webLink) {
      sheet.getRange(i + 2, webLinkCol + 1).setValue(webLink);
      updated++;
    }
  });
  
  SpreadsheetApp.getActive().toast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${updated} link web n√¢ng cao.`);
}


/** =======================================================
 * 3Ô∏è‚É£ D·ªåN D·∫∏P FOLDER D∆Ø (Gi·ªØ nguy√™n)
 * ======================================================= */
function checkAndCleanExtraFolders() {
  // (Gi·ªØ nguy√™n code)
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const nameCol = headers.indexOf("Name");
  const validNames = new Set(data.map(r => (r[nameCol] || "").toString().trim()).filter(Boolean));
  const root = DriveApp.getFolderById(DRIVE_ROOT_ID);
  const recycle = root.getFoldersByName("_Recycle").hasNext() ? root.getFoldersByName("_Recycle").next() : root.createFolder("_Recycle");
  const extras = [];
  const folders = root.getFolders();
  while (folders.hasNext()) {
    const f = folders.next();
    if (f.getName() === "_Recycle") continue;
    if (!validNames.has(f.getName().trim())) extras.push(f);
  }
  if (!extras.length) { SpreadsheetApp.getUi().alert("‚úÖ Kh√¥ng c√≥ folder d∆∞!"); return; }
  extras.forEach(f => { try { f.moveTo(recycle); } catch (err) { Logger.log("Kh√¥ng di chuy·ªÉn ƒë∆∞·ª£c: " + f.getName()); } });
  sheet.getRange("AB1").setValue(`L·∫ßn d·ªçn g·∫ßn nh·∫•t: ${new Date().toLocaleString("vi-VN")}`);
  SpreadsheetApp.getActive().toast(`üßπ ƒê√£ chuy·ªÉn ${extras.length} folder d∆∞ v√†o _Recycle.`);
}

/** =======================================================
 * 4Ô∏è‚É£ XU·∫§T JSON S·∫¢N PH·∫®M + CACHE (ƒê√É C·∫¨P NH·∫¨T)
 * ======================================================= */
function getImagesFromFolder(folderId) {
  try {
    const q = `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`;
    const res = Drive.Files.list({ q, fields: "files(id, name, mimeType)" });
    return (res.files || []).map(f => ({
      id: f.id,
      name: f.name,
      url: `https://drive.google.com/uc?export=view&id=${f.id}`,
      thumb: `https://lh3.googleusercontent.com/d/${f.id}=s1000`
    }));
  } catch (err) {
    Logger.log("Drive error: " + err.message);
    return [];
  }
}

function sheetToObjects(sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const values = sheet.getDataRange().getValues();
  const headers = values.shift();
  
  // (*** N√ÇNG C·∫§P V·∫•n ƒë·ªÅ 2 ***)
  const webLinkCol = headers.indexOf("Web Link");
  const modelCol = headers.indexOf("Model");
  const nameCol = headers.indexOf("Name");
  const cpuCol = headers.indexOf("CPU");
  const ramCol = headers.indexOf("RAM");
  const resCol = headers.indexOf("RESOLUTION");
  const gpuCol = headers.indexOf("GPU - CARD");

  return values.map((row, i) => {
    const obj = Object.fromEntries(headers.map((h, i) => [h, row[i]]));
    
    // (*** M·ªöI ***) Th√™m slug v√†o JSON
    if (webLinkCol > -1 && obj["Web Link"]) {
      obj.slug = obj["Web Link"]; // D√πng link ƒë√£ t·∫°o
    } else {
      // T·∫°o link fallback (n·∫øu ng∆∞·ªùi d√πng qu√™n ch·∫°y tool)
      const slugText = [
        obj["Model"] || obj["Name"],
        obj["CPU"],
        obj["RAM"],
        obj["RESOLUTION"],
        obj["GPU - CARD"]
      ].filter(Boolean).join(' ');
      obj.slug = `#${createSlug(slugText || `product-${i}`)}`;
    }
    
    return obj;
  });
}

/** ‚ö° C·∫≠p nh·∫≠t cache JSON s·∫£n ph·∫©m (ƒê√É C·∫¨P NH·∫¨T) */
/** ‚ö° C·∫≠p nh·∫≠t cache JSON (S·∫¢N PH·∫®M + BANNER) */
function updateCachedJson() {
  const cache = CacheService.getScriptCache();

  // 1. C·∫≠p nh·∫≠t cache s·∫£n ph·∫©m (nh∆∞ c≈©)
  const data = sheetToObjects(SHEET_NAME)
    .filter(p => p["Brand"])
    .map(p => {
      const folderId = extractFolderId(p["Folder Album Image Google Drive"]);
      const images = folderId ? getImagesFromFolder(folderId) : [];
      return { ...p, images }; // slug ƒë√£ ƒë∆∞·ª£c th√™m b·ªüi sheetToObjects
    });
  cache.put(CACHE_KEY_PRODUCTS, JSON.stringify(data), 21600); // 6h

  // 2. (*** M·ªöI ***) C·∫≠p nh·∫≠t cache banner
  const banners = getImagesFromFolder(FOLDER_ID_BANNER);
  cache.put(CACHE_KEY_BANNER, JSON.stringify(banners), 21600); // 6h

  SpreadsheetApp.getActive().toast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t cache JSON s·∫£n ph·∫©m V√Ä banner.");
}

/** üßπ X√≥a cache JSON s·∫£n ph·∫©m */
/** üßπ X√≥a cache JSON (S·∫¢N PH·∫®M + BANNER) */
function clearCachedJson() {
  const cache = CacheService.getScriptCache();
  cache.remove(CACHE_KEY_PRODUCTS);
  cache.remove(CACHE_KEY_BANNER); // <-- TH√äM D√íNG N√ÄY
  SpreadsheetApp.getActive().toast("üö´ ƒê√£ x√≥a cache JSON s·∫£n ph·∫©m V√Ä banner.");
}

/** doGet ‚Äî ph·ª•c v·ª• web (ƒê√É C·∫¨P NH·∫¨T) */
/** doGet ‚Äî ph·ª•c v·ª• web (ƒê√É C·∫¨P NH·∫¨T CACHE BANNER) */
function doGet(e) {
  const mode = e?.parameter?.mode;
  const cache = CacheService.getScriptCache(); // L·∫•y cache service 1 l·∫ßn

  // === (1) X·ª¨ L√ù BANNER ===
  if (mode === "banner") {
    const cached = cache.get(CACHE_KEY_BANNER);
    if (cached) {
      // N·∫øu c√≥ cache server, tr·∫£ v·ªÅ ngay
      return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);
    }

    // N·∫øu kh√¥ng c√≥ cache:
    const banners = getImagesFromFolder(FOLDER_ID_BANNER);
    const bannerJson = JSON.stringify(banners);
    cache.put(CACHE_KEY_BANNER, bannerJson, 21600); // L∆∞u cache server trong 6 gi·ªù
    return ContentService.createTextOutput(bannerJson).setMimeType(ContentService.MimeType.JSON);
  }

  // === (2) X·ª¨ L√ù S·∫¢N PH·∫®M (M·∫∑c ƒë·ªãnh) ===
  const cached = cache.get(CACHE_KEY_PRODUCTS);
  if (cached) {
    // N·∫øu c√≥ cache server, tr·∫£ v·ªÅ ngay
    return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);
  }

  // N·∫øu kh√¥ng c√≥ cache:
  const data = sheetToObjects(SHEET_NAME)
    .filter(p => p["Brand"])
    .map(p => {
      const folderId = extractFolderId(p["Folder Album Image Google Drive"]);
      const images = folderId ? getImagesFromFolder(folderId) : [];
      return { ...p, images }; // slug ƒë√£ ƒë∆∞·ª£c th√™m b·ªüi sheetToObjects
    });

  const productJson = JSON.stringify(data);
  cache.put(CACHE_KEY_PRODUCTS, productJson, 21600); // L∆∞u cache server trong 6 gi·ªù
  return ContentService.createTextOutput(productJson).setMimeType(ContentService.MimeType.JSON);
}

/** =======================================================
 * 5Ô∏è‚É£ NH·∫¨N ƒê∆†N H√ÄNG (ƒê√É N√ÇNG C·∫§P)
 * ======================================================= */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    // Ph√¢n lo·∫°i data: Ho·∫∑c l√† 'newOrder' ho·∫∑c l√† 'contactForm'
    let sheetName;
    let rowData;
    
    if (data.product) {
        // ƒê√¢y l√† ƒê∆†N H√ÄNG (v√¨ c√≥ 'product')
        sheetName = "Order";
        rowData = [new Date(), data.name, data.phone, data.product, data.note];
        
    } else if (data.message) {
        // ƒê√¢y l√† LI√äN H·ªÜ (v√¨ c√≥ 'message')
        sheetName = "Contact";
        rowData = [new Date(), data.name, data.phone, data.email || '', data.message];
        
    } else {
        throw new Error("Lo·∫°i POST kh√¥ng x√°c ƒë·ªãnh.");
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
    
    if (sheet.getLastRow() === 0) {
        // Th√™m header n·∫øu l√† sheet m·ªõi
        if (sheetName === "Order") {
            sheet.appendRow(["Th·ªùi gian", "T√™n", "ƒêi·ªán tho·∫°i", "S·∫£n ph·∫©m", "Ghi ch√∫"]);
        } else if (sheetName === "Contact") {
            sheet.appendRow(["Th·ªùi gian", "T√™n", "ƒêi·ªán tho·∫°i", "Email", "N·ªôi dung"]);
        }
    }

    sheet.appendRow(rowData);
    return ContentService.createTextOutput(JSON.stringify({ status: "ok" })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

/** =======================================================
 * 6Ô∏è‚É£ KI·ªÇM TRA FOLDER R·ªñNG (Gi·ªØ nguy√™n)
 * ======================================================= */
function checkEmptyImageFolders() {
  // (Gi·ªØ nguy√™n code)
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const nameCol = headers.indexOf("Name");
  const driveCol = headers.indexOf("Folder Album Image Google Drive");
  const statusCol = headers.indexOf("Tr·∫°ng th√°i t·∫°o folder") > -1 ? headers.indexOf("Tr·∫°ng th√°i t·∫°o folder") : headers.length;
  if (nameCol === -1 || driveCol === -1) { SpreadsheetApp.getUi().alert("‚ö†Ô∏è Thi·∫øu c·ªôt Name ho·∫∑c Folder Album Image Google Drive."); return; }
  const emptyFolders = [];
  let checked = 0;
  const rangeToClear = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
  rangeToClear.setBackground(null);
  data.forEach((row, i) => {
    const name = (row[nameCol] || "").toString().trim();
    const driveLink = (row[driveCol] || "").toString().trim();
    if (!driveLink) return;
    const folderId = extractFolderId(driveLink);
    if (!folderId) return;
    try {
      const query = `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`;
      const files = Drive.Files.list({ q: query, fields: "files(id)" }).files || [];
      checked++;
      if (files.length === 0) {
        const rowIndex = i + 2;
        emptyFolders.push({ row: rowIndex, name, link: driveLink });
        sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).setBackground("#fff8b3");
        sheet.getRange(rowIndex, statusCol + 1).setValue("‚ö†Ô∏è Folder r·ªóng (kh√¥ng c√≥ ·∫£nh)");
      }
    } catch (err) {
      const rowIndex = i + 2;
      emptyFolders.push({ row: rowIndex, name, link: driveLink, error: err.message });
      sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).setBackground("#ffcccc");
      sheet.getRange(rowIndex, statusCol + 1).setValue("‚ùå L·ªói ƒë·ªçc folder");
    }
  });
  if (emptyFolders.length === 0) { SpreadsheetApp.getUi().alert(`‚úÖ ƒê√£ ki·ªÉm tra ${checked} folder. T·∫•t c·∫£ ƒë·ªÅu c√≥ ·∫£nh!`); return; }
  let html = `
  <html><head><style>
    body{font-family:sans-serif;padding:10px;font-size:13px;} table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #ccc;padding:5px;} th{background:#f3f3f3;}
  </style></head><body>
  <h3>‚ö†Ô∏è Ph√°t hi·ªán ${emptyFolders.length} folder kh√¥ng ch·ª©a ·∫£nh</h3>
  <table><tr><th>H√†ng</th><th>T√™n s·∫£n ph·∫©m</th><th>Link folder</th><th>L·ªói</th></tr>
    ${emptyFolders.map((f) => `
      <tr><td>${f.row}</td><td>${f.name}</td>
        <td><a href="${f.link}" target="_blank">üîó M·ªü Folder</a></td>
        <td>${f.error || "Kh√¥ng c√≥ ·∫£nh"}</td></tr>`).join("")}
  </table>
  <p><i>‚Üí C√°c d√≤ng r·ªóng ƒë√£ ƒë∆∞·ª£c t√¥ <b style="color:#b36b00;">v√†ng c·∫£nh b√°o</b> ho·∫∑c <b style="color:red;">ƒë·ªè l·ªói</b> tr√™n sheet Web.</i></p>
  </body></html>`;
  SpreadsheetApp.getUi().showSidebar(HtmlService.createHtmlOutput(html).setTitle("üñº Folder r·ªóng"));
}